## 内存会出现的问题

1. 内存泄漏
2. 内存溢出

## 内存泄漏

内存泄漏(Memory Leak)：是指程序在申请内存后，无法释放已申请的内存空间，一次内存泄漏似乎不会有大的影响，但内存泄漏堆积后的后果就是内存溢出

## 内存溢出

内存溢出(Memory Overflow)：指程序申请内存时，没有足够的内存供申请者使用，或者说，给了你一块存储int类型数据的存储空间，但是你却存储long类型的数据，那么结果就是内存不够用，此时就会报错OOM,即所谓的内存溢出。

## 内存泄漏、内存溢出 关系

1. 内存泄漏的堆积最终会导致内存溢出。内存溢出就是你要的内存空间超过了系统实际分配给你的空间，此时系统相当于没法满足你的需求，就会报内存溢出的错误。
2. OOM，是 Out of Memory 的缩写，指的是 App 占用的内存达到了 iOS 系统对单个 App 占用内存上限后，而被系统强杀掉的现象
3. OOM 其实也属于应用“崩溃”中的一种，是由 iOS 的 Jetsam 机制导致的一种“另类”崩溃，并且日志无法通过信号捕捉到。

## 内存泄漏

### 内存泄漏可能会出现的几种原因，聊聊你的看法？

1. 发生强引用
	- block
	- timer、displaylink与 target
	- delegate
2. 线程死锁
3. 短时间创建大量对象造成内存暴涨
4. 非oc对象内存处理
	- calloc 后没有free
	- cgimage后需要 cgimagerelease
5. timer 使用后没有停止和销毁
6. notification使用后没有remove
7. 地图功能处理

### 追问一：非OC对象如何处理？

1. cgimage 绘制出来，在绘制完成后需要手动进行释放 cgimagerelease
2. malloc后需要手动 free

### 追问二：地图类内存若泄漏，如何处理？

1. 需在使⽤完毕时将地图、代理等滞空为nil；
2. 注意地图中标注（⼤头针）的复⽤，并且在使⽤完毕时清空标注数组等

### 内存泄漏怎么检查的？

1. 线下监控：xcode - Instruments 性能检测工具 - leaks 工具
2. leaks：测量内存使用情况，检查泄漏内存，并按照类来提供对象分配的统计信息，以及所有活动分配和泄漏内存地址历史信息
3. 线上监控：todo？？

### leaks 和 allocations？
1. leaks：测量内存使用情况，检查泄漏内存，并按照类来提供对象分配的统计信息，以及所有活动分配和泄漏内存地址历史信息
2. allocations：跟踪进程的匿名虚拟内存和堆，为对象提供类名和可选的 retain、release历史记录

## 内存溢出

### 通过内存警告获取内存限制值

通过 XNU 的宏获取内存限制，需要有 root 权限，而 App 内的权限是不够的，所以正常情况下，作为 App 开发者你是看不到这个信息的。那么，如果你不想越狱去获取这个权限的话，还可以利用 didReceiveMemoryWarning 这个内存压力代理事件来动态地获取内存限制值。

### 如何获取当前内存使用情况

iOS 系统在强杀掉 App 之前还有 6 秒钟的时间，足够你去获取记录内存信息了。那么，**如何获取当前内存使用情况呢？**

iOS 系统提供了一个函数 task_info， 可以帮助我们获取到当前任务的信息。

代码中，task_info_t 结构里包含了一个 resident_size 字段，用于表示使用了多少内存。这样，我们就可以获取到发生内存警告时，当前 App 占用了多少内存。代码如下：

```
float used_mem = info.resident_size;

NSLog(@" 使用了 %f MB 内存 ", used_mem / 1024.0f / 1024.0f)
```

## 定位内存问题信息收集

要想精确地定位问题，我们就需要 dump 出完整的内存信息，包括所有对象及其内存占用值，在内存接近上限值的时候，收集并记录下所需信息，并在合适的时机上报到服务器里，方便分析问题。

获取到了每个对象的内存占用量还不够，你还需要知道是谁分配的内存，这样才可以精确定位到问题的关键所在。一个对象可能会在不同的函数里被分配了内存并被创建了出来，当这个对象内存占用过大时，如果不知道是在哪个函数里创建的话，问题依然很难精确定位出来。那么，**怎样才能知道是谁分配的内存呢？**

## 谁分配的内存

在这里，我主要是针对大内存的分配监控，所以只针对 scalable_zone 进行分析，同时也可以过滤掉很多小内存分配监控。

使用 scalable_zone 分配内存的函数都会调用 malloc_logger 函数，因为系统总是需要有一个地方来统计并管理内存的分配情况。

具体实现的话，你可以查看 malloc_zone_malloc 函数的实现。

其他使用 scalable_zone 分配内存的函数的方法也类似，所有大内存的分配，不管外部函数是怎么包装的，最终都会调用 malloc_logger 函数。你可以使用 fishhook 去 Hook 这个函数，加上自己的统计记录就能够通盘掌握内存的分配情况。出现问题时，将内存分配记录的日志捞上来，你就能够跟踪到导致内存不合理增大的原因了。

重要：**根据所讲的 hook malloc_logger 的方法，实现了一个记录内存分配的小工具**（fishhook）。

### 内存溢出怎么检查的？

1. Instrument - Allocations：可以查看虚拟内存占用、堆信息、对象信息、调用栈信息，VM Regions 信息等。可以利用这个工具分析内存，并针对地进行优化
2. 线上检测，通过内存警告获取内存限制值