# 性能优化-内存崩溃

## 常见的内存崩溃

1. 内存溢出：OOM，是 Out of Memory 的缩写，指的是 App 占用的内存达到了 iOS 系统对单个 App 占用内存上限后，而被系统强杀掉的现象。OOM 其实也属于应用“崩溃”中的一种，是由 iOS 的 Jetsam 机制导致的一种“另类”崩溃，并且日志无法通过信号捕捉到。
2. 访问未分配的内存：XNU 会报 EXC_BAD_ACCESS 错误，信号为 SIGSEGV Signal #11 。
3. 没有遵守权限访问内存：内存页面的权限标准类似 UNIX 文件权限。如果去写只读权限的内存页面就会出现错误，XNU 会发出 SIGBUS Signal #7 信号。

注意：“访问未分配的内存”和“没有遵守权限访问内存”问题都可以通过崩溃信息获取到，在收集崩溃信息时如果发现是这两类，我们就可以把内存分配的记录同时传过来进行分析，对于不合理的内存分配进行优化和修改。

## 内存问题监控手段

### 线下监控手段

1. Zombie 和 Address Sanitizer：僵尸对象和地址内存错误检测，可以在绝大多数情况下定位 EXC_BAD_ACCESS 问题代码，EXC_BAD_ACCESS 主要原因是访问了某些已经释放的对象，或者访问了它们已经释放的成员变量或方法。
2. Instruments-Allocations：跟踪进程的匿名虚拟内存和堆，为对象提供类名和可选的 retain、release历史记录。可以查看虚拟内存占用、堆信息、对象信息、调用栈信息，VM Regions 信息等。可以利用这个工具分析内存，并针对地进行优化。
3. 通过 XNU 获取内存限制值：通过 XNU 的宏获取内存限制，需要有 root 权限，而 App 内的权限是不够的，所以正常情况下，作为 App 开发者你是看不到这个信息的。那么，需要越狱去获取这个权限。

注意：1是坏内存访问，EXC_BAD_ACCESS 错误，主要是访问了某些已经释放的对象，或者访问了它们已经释放的成员变量或方法；2、3是检查内存溢出；3需要越狱才能获取权限。

### 线上监控手段

1. 通过 JetsamEvent 日志计算内存限制值：查看手机中以 JetsamEvent 开头的系统日志（我们可以从设置 -> 隐私 -> 分析中看到这些日志）。
2. 通过内存警告获取内存限制值： 可以利用 didReceiveMemoryWarning 这个内存压力代理事件来动态地获取内存限制值。iOS 系统在强杀掉 App 之前还有 6 秒钟的时间，足够你去获取记录内存信息了。

注意：1是获取内存上限值，2是监控到 App 因为占用内存过大而被强杀的时机，然后获取当前内存使用情况，一般使用这两种。

## 内存问题信息收集

1. 内存分配函数 malloc 和 calloc 等默认使用的是 nano_zone。nano_zone 是 256B 以下小内存的分配，大于 256B 的时候会使用 scalable_zone 来分配。
2. 这里主要是针对大内存的分配监控，所以只针对 scalable_zone 进行分析，同时也可以过滤掉很多小内存分配监控。比如，malloc 函数用的是 malloc_zone_malloc，calloc 用的是 malloc_zone_calloc。
3. 使用 scalable_zone 分配内存的函数都会调用 malloc_logger 函数，因为系统总是需要有一个地方来统计并管理内存的分配情况。（malloc_zone_malloc 函数中，在 zone 分配完内存后就开始使用 malloc_logger 进行进行记录。）
4. 可以使用 fishhook 去 Hook 这个函数，加上自己的统计记录就能够通盘掌握内存的分配情况。出现问题时，将内存分配记录的日志捞上来，你就能够跟踪到导致内存不合理增大的原因了。

## 内存使用量的线上监控方法

1. 在获取 iOS 应用内存使用量时，都是使用 task_basic_info 里的 resident_size 字段信息。但是，我们发现这样获得的内存使用量和 Instruments 里看到的相差很大。
2. 内存信息存在 task_info.h （完整路径 usr/include/mach/task.info.h）文件的 task_vm_info 结构体中，其中 phys_footprint 就是物理内存的使用，而不是驻留内存 resident_size。
3. 类似于对 CPU 使用率的监控，我们只要从这个结构体里取出 phys_footprint 字段的值，就能够监控到实际物理内存的使用情况了。
4. 线上性能监控方案代码和业务逻辑是完全解耦的，监控时基本都是直接获取系统本身提供的数据，没有额外的计算量，因此对 App 本身的性能影响也非常小。

## 内存打爆信息收集

1. 对于内存打爆信息的收集，你可以采用内存映射（mmap）的方式来保存现场。
2. 注意：采用内存映射（mmap）的方式来保存现场，具体有待验证。